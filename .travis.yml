language: node_js
node_js:
- '6'

env:
  global:
  - STABLE_BRANCH=master
  - DEVELOP_BRANCH=v0.2.0
  - DOCKER_SRC_IMAGE=rra-api
  - DOCKER_REPOSITORY=wbtransport/rra-api
  - DOCKER_USERNAME=olafveerman
  - secure: NQ7uWGTr4z42PevZ4jFt/YOA85S52SjaUNfvvPTWkWISohfrXJrnm/NNMOFJrl1YZNgI0AtGUDy1EVLyUQwzhm9RnBqb+pig8CxTwr6ev9aaa9EqC9H/YtrDY97qOFjFW8uZvJ8i5G+vadchR7d5rsRJU/N712ItJ5uutZ7Nt3Hx9ab0zjSdZMh3+MHTZeElhMSWJER8kM46C9nQQoPmI2f0qqL8m/ywO8ezh5w2nmC3aE7Hy6xbqJgNzfgmBDPw806H+gFI7u+bwk4lJhaE0dyfjyevg373CautBXHSQGzxqw5om6lGMDhAP7VfU9CCszmt9DhWq9uk1JDJJsM5uv7GOSSugXLg3ozLjkVsyqRA2+J49r3ukgdelvKBbxywJsTKnPzyKG6WVPxNa0HXJY5Hutnr5ToeV3T7kal9HsbpNAw4LYW7zTK/l5lKN+R6OfaZk82ifDTQjw5w+2FvQiZ7VlVuxwgmzRJoURXz3aNjCErOUfQCcJdSN4On34n5ja9fMpMUlEP1eVoY+qjgB0fZBsuaPqUMY1/zQMhrrYr01/cRn/xDDgZ/+SyeR7VBEpSaPue40LLpZc2Rfs6fLVPPHIkHctEei0p2hcw1AtbMcbjPH33It3oSevGWJSKH1+iTHSNUpCcYLxgfH95RyYxgEfAXh/Ms5tjPy4MJN+E=
  - DB_TEST_CONNECTION=postgresql://rratest:rratest@localhost:5432/rratest
  - STORAGE_TEST_ENGINE=minio
  - STORAGE_TEST_ACCESS_KEY=minio
  - STORAGE_TEST_SECRET_KEY=miniostorageengine
  - STORAGE_TEST_BUCKET=rra-test
  - STORAGE_TEST_REGION=us-east-1

cache:
  apt: true
  directories:
  - node_modules

services:
  - docker

before_script:
  - sudo /etc/init.d/postgresql stop
  - docker-compose up -d
  - sleep 10 # Wait for the docker container with db to be up
  - DS_ENV=test npm run setup -- --db --bucket

script:
  - npm test

deploy:
  - provider: script
    skip_cleanup: true
    script: .build_scripts/deploy.sh
    on:
      branch: ${DEVELOP_BRANCH}
  - provider: script
    skip_cleanup: true
    script: .build_scripts/deploy.sh
    on:
      branch: ${STABLE_BRANCH}
